# 선착순 쿠폰 발급 장애 보고서

## 1. 개요

이번 장애는 다수의 유저가 선착순 쿠폰 발급을 위해 동시에 접속하면서 발생한 DB 락 문제로 인해, 요청 대기 시간이 길어져 타임아웃 현상이 나타난 사건입니다. 장애로 인해 선착순 쿠폰 발급 기능을 이용하는 사용자들이 정상적으로 쿠폰을 받을 수 없는 상황이 발생하였습니다.

## 2. 장애 발생 상세 내용

- **장애 요약:**  
  다수의 유저가 동시에 선착순 쿠폰 발급 기능에 접근하면서, 기존 DB 락 처리 방식에 의한 대기 시간 초과로 타임아웃 현상이 발생했습니다.

- **장애 탐지 시간:**  
  2025-02-27 14:00

- **장애 종료 시간:**  
  2025-02-27 14:30

- **영향받은 서비스/기능:**  
  선착순 쿠폰 발급 기능

- **영향 대상:**  
  선착순 쿠폰 발급을 위해 동시에 접속한 유저

## 3. 타임라인

- **14:00:00** – **장애 인지:**  
  시스템 모니터링 도구에서 비정상적인 응답 지연 및 에러 발생을 감지.

- **14:01:00** – **초기 분석 시작:**  
  모니터링 팀이 로그 및 트래픽 데이터를 검토하여 문제의 범위를 파악하기 시작.

- **14:02:05** – **개발팀 전파:**  
  장애 사실과 초기 분석 결과를 관련 개발팀과 운영팀에 즉시 공유.

- **14:04:00** – **원인 추정:**  
  초기 로그 분석을 통해 다수의 동시 요청으로 인한 DB 락 현상이 문제의 원인일 가능성이 높음을 확인.

- **14:06:34** – **서버 재시작:**  
  임시 대응 조치로 서버 재시작을 실시하여 DB 락 현상을 완화하려 시도.

- **14:08:00** – **추가 로그 및 시스템 상태 분석:**  
  재시작 후에도 지속되는 문제를 확인하고, 세부 원인 분석을 위해 추가 로그 및 모니터링 데이터를 수집.

- **14:12:00** – **대응 방안 논의:**  
  긴급 회의를 통해 DB 락 문제의 근본 원인을 제거할 수 있는 해결책으로 Redis 도입을 결정.

- **14:15:00** – **Redis 도입 계획 수립:**  
  Redis 기반의 락 시스템 적용을 위한 구체적인 계획과 초기 설정 작업을 시작.

- **14:20:00** – **Redis 전환 및 테스트:**  
  Redis 기반 시스템으로 전환한 후, 부하 테스트를 진행하여 기존 DB 락 문제의 해결 여부를 확인.

- **14:25:00** – **서비스 안정화 확인 및 사용자 공지:**  
  모니터링 결과 안정적인 응답 속도를 확인한 후, 사용자에게 서비스 복구 및 정상 운영 상황을 공지.

- **14:30:00** – **장애 종료 및 최종 점검:**  
  모든 시스템이 정상 운영됨을 최종 확인하고, 장애 종료 처리를 완료.

## 4. 장애 원인 및 분석

- **원인:**  
  선착순 쿠폰 발급 기능에서 동시 접속하는 다수의 유저 요청이 DB 락을 유발하였고, 이로 인해 DB 처리 지연 및 타임아웃 문제가 발생.

- **상세 분석:**  
  기존 시스템은 DB 락을 통한 동시성 제어 방식을 사용하였으나, 사용자가 몰릴 경우 락 획득 경쟁으로 인한 대기열이 길어져 결과적으로 타임아웃이 발생하는 문제가 발생하였고. 
이로 인해 사용자 경험에 큰 영향을 주었으며, 시스템의 안정성에도 문제가 있음을 확인할 수 있다.

## 5. 대응 조치 및 해결 방법

### 5.1 초기 대응

- **서버 재시작:**  
  장애 상황 발생 직후 서버를 재시작하여 임시로 DB 락 문제를 완화하고, 서비스 복구에 노력 및 빠른 복구 작업

### 5.2 근본적인 해결책 – Redis 도입

- **문제 해결 방향:**  
  DB 락 문제의 근본 원인을 제거하기 위해, 동시성 제어에 최적화된 인메모리 데이터 저장소인 Redis를 도입.

- **도입 효과:**  
  Redis 기반의 락 메커니즘은 DB에 직접 락을 걸지 않고, 빠른 응답 속도와 높은 동시성 처리 능력을 제공함으로써 기존 DB 락 문제를 효과적으로 해소.

### 5.3 테스트 결과 비교

- **기존 디비락 테스트 결과:**  
  기존 시스템의 부하 테스트 결과에서는 다수의 유저가 동시에 접속할 경우, DB 락으로 인한 지연 및 타임아웃 현상이 나타남.  
  [기존 디비락 테스트 결과 바로가기](https://app.artillery.io/olej5drvnso5b/load-tests/txch3_xw3zbr6pb7z3yw3rebtkxj8hz4nbb_bm86)

- **레디스 전환 테스트 결과:**  
  Redis를 도입한 후의 부하 테스트 결과에서는 동시 접속 시에도 락 문제 없이 안정적인 응답 속도를 유지하는 결과를 확인 할수 있음.  
  [레디스 전환 테스트 결과 바로가기](https://app.artillery.io/olej5drvnso5b/load-tests/t683j_8ygbyk7qbhw5zbypktwz5m8fqfyhw_3ker)

## 6. 재발 방지 대책

- **지속적인 모니터링:**  
  시스템 모니터링 도구를 강화하여 유사 장애 발생 시 즉각 대응할 수 있도록 실시간으로 상태를 점검.

- **정기 부하 테스트:**  
  주기적인 부하 테스트 및 시나리오 테스트를 통해 시스템의 한계를 사전에 파악 및 개선 사항 확인.
