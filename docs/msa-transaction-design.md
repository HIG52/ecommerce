# MSA 전환을 위한 도메인 분리와 트랜잭션 관리 전략

---

## 목차

1. 서론
    - 개요
    - 서비스 확장의 필요성과 MSA 전환 배경
    - 기존 모놀리식 시스템과의 차이점
   

2. MSA 기반 서비스 분리 전략
   - 도메인별 서비스 분리 기준
   - 서비스 간 통신 방식 (REST, gRPC, 메시지 브로커)
   - 데이터 저장소 분리 및 연관 데이터 처리


3. 트랜잭션 처리의 한계점
   -  분산 트랜잭션과 기존 트랜잭션의 차이
   -  데이터 정합성 문제
   -  네트워크 장애 등 성능 및 지연 시간 이슈

4. 트랜잭션 처리 해결 방안
   - SAGA 패턴
   - Choreography 방식
   - Orchestration 방식
   - 2PC (Two-Phase Commit)와 한계점
   - 보상 트랜잭션 및 재시도 전략
   - 이벤트 소싱 및 CQRS 활용
   - Idempotency(멱등성) 적용
   - 분산 락과 일관성 보장 전략


5. MSA 환경에서의 트랜잭션 모니터링 및 장애 대응
   - 트랜잭션 모니터링 도구 및 로깅
   - 장애 감지 및 복구 전략
   - 서킷 브레이커 패턴 적용


6. 결론
   - 서비스 분리에 따른 장점과 단점
   - 트랜잭션 관리 전략 요약
   - 향후 확장 가능성과 고려사항

7. 부록
   - 참고 자료
   - 구현 예제 및 코드 샘플

---

## 서론

### 문서 개요
서비스가 확장됨에 따라 기존의 모놀리식 아키텍처에서 MSA(Micro Service Architecture)로 전환해야하는 필요성이 증가함에 따라
본 문서는 서비스 분리에 따른 트랜잭션의 처리 한계와 해결방안을 중심으로 MSA 전환 시 고려해야 할 사항들을 정리하였다.

### 서비스 확장의 필요성과 MSA 전환 배경
- 대용량 트래픽으로 인한 성능 이슈
- 도메인별 독립적인 배포 및 유지보수의 필요성 증가
- 서비스 확장에 따른 팀의 세분화로 인한 팀간 분업 및 개발 생산성 증가
- 특정 서비스의 개별 확장 필요성

### 기존 모놀리식 시스템과의 차이점

| 항목          | 모놀리식 아키텍처 | 마이크로서비스 아키텍처 |
|--------------|----------------|------------------|
| 서비스 구성  | 하나의 애플리케이션 내에서 모든 기능 제공 | 도메인별로 독립적인 서비스 분리 |
| 데이터 저장소 | 단일 데이터베이스 | 서비스별 개별 데이터베이스 유지 |
| 배포 방식    | 전체 시스템 배포 필요 | 개별 서비스 단위 배포 가능 |
| 장애 영향도  | 하나의 서비스 장애가 전체 시스템에 영향 | 특정 서비스 장애가 전체 시스템에 미치는 영향 최소화 |
| 트랜잭션 관리 | 단일 DB 내에서 ACID 보장 | 분산 트랜잭션 관리 필요 |

---

## MSA 기반 서비스 분리 전략

### 도메인별 서비스 분리 기준

- 도메인 주도 설계(DDD)를 활용하여 비지니스 기능 중심으로 도메인을 분리한다.
- 현재 모놀리식으로 구성된 이커머스에서 예시를 든다면 회원/결제/상품 등을 분리할수 있다.


&rarr; 핵심 기능은 다른 기능들과의 결합도가 높을 가능성이 크기 때문에 의존성 분석 과정이 필요하다.

&rarr; 최대한 의존성을 줄이도록 경계를 지으면서 응집도있고 서비스의 변경에 대한 이유는 하나의 비지니스 영역 때문이도록 하여야 한다.

### 서비스 간 통신 방식

마이크로 서비스들끼리 통신하는 방법에는 크게 동기 방식과 비동기 방식이 존재한다.

- 동기 통신 : 
  - HTTP/REST : 일반적인 통신 방법으로 API를 이용하여 서비스간 HTTP 요청과 응답을 주고 받는다.
  - gRPC : 구글이 개발한 고성능 RPC 프레임워크로, HTTP/2를 사용하여 통신한다.

- 비동기 통신 : 
  - 메시지 큐 : RabbitMQ, Apache Kafka 와 같은 메시지 큐 시스템을 사용하여 서비스 간 비동기적으로 메시지를 전달한다.
  - 이벤트 스트리밍 : Apache Kafka, Amazon Kinesis와 같은 시스템을 사용하여 이벤트 기반으로 데이터 스트림을 처리한다.

*해당 동기, 비동기 통신 외에도 다양한 통신 방법이 존재한다.*

### 데이터 저장소 분리 및 연관 데이터 처리

- 도메인에 맞게 독립된 데이터 저장소를 사용하도록 기존 DB를 분리한다.
- 부득이하게 DB를 합쳐야 하는경우 (예시 : 사용자 데이터 기반 개인화 상품추천 기능 / 구매내역 또는 장바구니 목록이 필요) 
    - MySQL Multi-Source Replication 기능을 사용하여 여러개의 MasterDB 에서 한개의 Slave DB로 동기화 하여 데이터를 통합한다.
    - Replication 방식을 사용한다.

---

## MSA 환경 트랜잭션 처리의 한계점

### 분산 트랜잭션과 기존 트랜잭션의 차이

- 모놀리식 트랜잭션 : 
  - 단일 데이터베이스 내에서 모든 작업이 원자적으로 수행된다.

- 분산 트랜잭션 : 
  - 여러 서비스와 데이터 저장소에 걸쳐 트랜잭션을 수행 해야하므로, 네트워크 지연, 부분실패, 동기화등 추가적인 작업이 필요하다.

### 데이터 정합성 문제

- 각 서비스간 데이터 전파에 지연이 존재하여 **실시간 일관성** 유지가 어려울수도 있다.
- **분산 락, 버전 관리** 등을 통하여 정합성 문제를 해결해야한다.
- 실패시 이전 상태를 복구 하기위한 **보상 트랜잭션** 등의 로직을 구현해야한다.

### 네트워크 장애 등 성능 및 지연 시간 이슈

- 네트워크 통신 장애로 인한 트랜잭션 중지 및 지연이 발생하여 성능에 이슈가 생길수 있음
- 서비스 간에 통신 지연문제에 경우 전체 트랜잭션의 처리시간이 늘고 시스템 응답을 저하시킬수 있다.

---

## 트랜잭션 처리 해결 방안

### SAGA 패턴
- 분산 트랜잭션 환경에서 메시지 또는 이벤트를 주고 받으며 특정 마이크로서비스에서의 작업이 실패하면 이전까지의 작업이 완료된 마이크로서비스들에게
보상 이벤트를 소싱 함으로써 분산환경에서 원자성을 보장해주는 패턴이다.
- 크게 Choreography based SAGA pattern 과 Orchestration based SAGA pattern 으로 나뉜다.

    - 

---

## 부록

### 참고 자료

https://www.atlassian.com/ko/microservices/microservices-architecture/microservices-vs-monolith

https://velog.io/@sorzzzzy/MSA-MSAMicroService-Architecture%EB%9E%80

https://velog.io/@suhongkim98/MSA%EC%99%80-DDD-%EB%A7%88%EC%9D%B4%ED%81%AC%EB%A1%9C%EC%84%9C%EB%B9%84%EC%8A%A4-%EA%B0%84-%ED%86%B5%EC%8B%A0-%EB%B0%A9%EB%B2%95-4-%EC%9E%91%EC%84%B1-%EC%A4%91

https://systorage.tistory.com/entry/%EB%A7%88%EC%9D%B4%ED%81%AC%EB%A1%9C%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98MSA%EC%97%90%EC%84%9C-%EB%AA%A8%EB%93%88-%EA%B0%84-%ED%86%B5%EC%8B%A0-%EB%B0%A9%EB%B2%95

https://devocean.sk.com/blog/techBoardDetail.do?ID=166825&boardType=techBlog

https://learn.microsoft.com/ko-kr/azure/architecture/patterns/saga

https://azderica.github.io/01-architecture-msa/

https://tech.kakaopay.com/post/msa-transaction/